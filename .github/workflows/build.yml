# GitHub Actions Workflow created for testing and preparing the plugin release in the following steps:
# - validate Gradle Wrapper,
# - run test and verifyPlugin tasks,
# - run buildPlugin task and prepare artifact for the further tests,
# - run IntelliJ Plugin Verifier,
# - create a draft release.
#
# Workflow is triggered on push and pull_request events.
#
# Docs:
# - GitHub Actions: https://help.github.com/en/actions
# - IntelliJ Plugin Verifier GitHub Action: https://github.com/ChrisCarini/intellij-platform-plugin-verifier-action

name: Build
on:
  # Trigger the workflow on pushes to only the 'master' branch (this avoids duplicate checks being run e.g. for dependabot pull requests)
  push:
    branches:
      - main

jobs:

  # Prepare a draft release for GitHub Releases page for the manual verification
  # If accepted and published, release workflow would be triggered
  releaseDraft:
    name: Release Draft
    if: startsWith(github.ref_name, 'mai') && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:

      # Check out the current repository
      - name: Fetch Sources
        uses: actions/checkout@v5

      # Remove old release drafts
      - name: Remove Old Release Drafts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.ref_name }}"
          gh api repos/{owner}/{repo}/releases \
            --jq ".[] | select(.draft == true and .target_commitish == \"${BRANCH}\") | .id" \
            | xargs -I '{}' gh api -X DELETE repos/{owner}/{repo}/releases/{}

      # Create new release draft - which is not publicly visible and requires manual acceptance
      - name: Create Release Draft
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.ref_name }}"
          TAG="v2026.2.2"

          if DRAFT="$(gh api repos/{owner}/{repo}/releases/tags/$TAG --jq '.draft' 2>/dev/null)"; then
            if [ "$DRAFT" = "false" ]; then
              echo "Release $TAG already exists and is not a draft. Skipping draft creation."
              exit 0
            fi
          else
            echo "=====${DRAFT}===="
          fi

          gh release create "$TAG" \
            --target "$BRANCH" \
            --draft \
            --title "$TAG" \
            --notes "$(cat << 'EOM'
          ## What's Changed

          EOM
          )"
